<!DOCTYPE html>
<html>
<head>
	<title>My JavaScript Project</title>
	
	<script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
	
	<script src="https://unpkg.com/xdomain@0.8.2/dist/xdomain.min.js" 
		slave="https://pset-api.connect.trimble.com/v1/proxy.html"></script>
</head>
<body>
<!-- <script src="https://jonathang89.github.io/TrimbleConnectTest/script.js"/> -->

<script type="text/javascript"
	slave="https://pset-api.connect.trimble.com/v1/proxy.html">
    console.log("Test log");
    	
    getData();

    async function getData() {
     const API = await TrimbleConnectWorkspace.connect(window.parent, (event, data) => {
        console.log("Event: ", event, data);
     });

     
     console.log("Window Parent: ", window.parent);
     
     const responseProject = await API.project.getProject();
     console.log("Response Project: ", responseProject); // Trimble Connect project details
     const projectId = responseProject.id;
     
     const responseAccessToken = await API.extension.requestPermission("accesstoken");
     console.log("responseAccessToken: ", responseAccessToken);
     const accessToken = responseAccessToken;

     const psetBaseString = 'https://pset-api.eu-west-1.connect.trimble.com/';
     const orgBaseString = "https://org-api.eu-west-1.connect.trimble.com/v1/";
// Test part

     const modelId = "-BkehdN_NAw";
     const loadedModelState = {
      state: "loaded"
     };
    
     const viewerModel = Array.from(await API.viewer.getModels());
     const viewerObject = await API.viewer.getObjectProperties(modelId);

     console.log("viewerModel: ", viewerModel[2]);
    //  console.log("viewerObject: ", viewerModel);

     const libLinkString = "libs/qi066d9wu4kuw8pz115tt3up3b4g7ph7/defs";
     const psetLibsString = psetBaseString.concat(libLinkString);

     console.log("debut test: ");

     const responsePset = await fetch(psetLibsString, {
        method: 'Get',
        headers: {
          'Access-Control-Allow-Origin':'*',
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${accessToken}`
        }
     });

// End Test Part
     
    //  const apiUrl = `https://pset-api.connect.trimble.com/v1/psets/${projectId}/defs`;
     const meUrl = `https://org-api.eu-west-1.connect.trimble.com/v1/forests/project%3A${projectId}%3Adata/trees`;
     const tcpUrl = 'https://web.connect.trimble.com//projects/kqafPqVOb7U/property-set-libraries';

    //  const responseMe = await fetch(meUrl, {
    //     method: 'Post',
    //     headers: {
    //       'Access-Control-Allow-Origin':'*',
    //       'Content-Type': 'application/json',
    //       'Authorization': `Bearer ${accessToken}`
    //     }
    //  });
     
    //  console.log("Test info:", responseMe);
    //  console.log("Test info json:", responseMe.json());

     console.log("fin test:");
     
     const responseData = await fetch(meUrl, {
        method: 'Get',
        headers: {
          'Access-Control-Allow-Origin':'*',
          'Authorization': `Bearer ${accessToken}`
        }
     });

     const jsonData = await responseData.json();
	    
     /*const propertyName = 'Propriété Test';
     const propertyValue = 'Test';
     const filter = `properties/${propertyName} ne null`;
     const apiUrl = `https://pset-api.connect.trimble.com/propertyset/v1/projects/${projectId}/propertyset-instances?filter=${encodeURIComponent(filter)}`;

     */
    const responseTest = await fetch(tcpUrl, {
       method: 'GET',
       headers: {
         'Content-Type': 'application/json',
         'Authorization': `Bearer ${accessToken}`
       },
    });

    console.log(responseTest);
	    
     console.log('response : ', responseData);
     console.log('response json : ', jsonData);

    }
 </script>
	
</body>
</html>
