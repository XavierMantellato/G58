<!DOCTYPE html>
<html>
<head>
	<title>My JavaScript Project</title>
	
   <link rel="stylesheet" type="text/css" href="./CSS/index.css">
	<script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
   <script src="./ModelsJs/Project.js"></script>
   <script src="./ModelsJs/API_Rests/PsetsRequests.js"></script>
   <script src="./Helpers/RequestHelper.js"></script>
	
	<script src="https://unpkg.com/xdomain@0.8.2/dist/xdomain.min.js"></script>
</head>
<body>

   <h2 class="Title2-center">Arkance Extension</h2>

   <hr>
   
   <div style="text-align: center; margin: 5px;">
      <button id="btnCreate">Create folders</button>
   </div>

<!-- <script src="https://jonathang89.github.io/TrimbleConnectTest/script.js"/> -->
<script type="module">
   xdomain.slaves({
    "https://pset-api.connect.trimble.com": "/v1/proxy.html",
    "https://org-api.connect.trimble.com": "/v1/proxy.html"
  });
   //  console.log("Test log");

      const psetBaseString = 'https://pset-api.connect.trimble.com/v1/';
      const orgBaseString = "https://org-api.connect.trimble.com/v1/";
      const appBaseString = "https://app21.connect.trimble.com/tc/api/2.0/";
      const modelApiBaseString = "https://model-api21.connect.trimble.com/";

      console.log("Api:");

      const API = await TrimbleConnectWorkspace.connect(window.parent, (event, data) => {
        console.log("Event: ", event, data);
      });

      const responseProject = await API.project.getProject();
      console.log("Response Project: ", responseProject); // Trimble Connect project details
      const projectId = responseProject.id;

      const responseAccessToken = await API.extension.requestPermission("accesstoken");
      console.log("responseAccessToken: ", responseAccessToken);
      const accessToken = responseAccessToken;
    	
      var headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }

      const projectForestString = orgBaseString.concat(`forests/project:${projectId}:data/trees/ProjectContext/nodes/PSetLibs`);

      const projectForestTreesString = orgBaseString.concat(`forests/project:${projectId}:data/trees`);

      const appProjectInfoProject = appBaseString.concat(`projects/${projectId}`);

      const responseProjectInfo =  await fetch(appProjectInfoProject, {
         method: 'GET',
         headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }
      });

      let projectInfo = await responseProjectInfo.json();
      var rootId = projectInfo.rootId;
      
      console.log("baseFolderId: ", rootId);

      const responseModels = await API.viewer.getModels();

      console.log("models: ", responseModels);

      const model = responseModels[2];

      console.log("endApi:")
   
   document.getElementById("btnCreate").onclick = function() { createFolderHierarchy() };

   async function createFolderHierarchy()
    {
      const responseModel = await API.viewer.getModels();
      const model = responseModel[2];

      var params = "include=id,idx,psets,psets.name";

      // var modelContext = {};

      const modelInfoString = modelApiBaseString.concat(`models/${model.id}/entities`);

      const responseModelInfo =  await fetch(modelInfoString, {
         method: 'GET',
         headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }
      });

      let modelInfos = await responseModelInfo.json();

      let modelEntities = modelInfos.items;

      console.log("modelEntities: ", modelEntities);

      const responseProjectInfo =  await fetch(appProjectInfoProject, {
         method: 'GET',
         headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }
      });

      console.log("creating folder:");
      
      // const appBaseFolderString = appBaseString.concat(`folders/${rootId}/items`);
      
      // const responseFolderInfo =  await fetch(appBaseFolderString, {
      //    method: 'GET',
      //    headers: {
      //       'Content-Type': 'application/json',
      //       'Authorization': `Bearer ${accessToken}`
      //    }
      // });

      let rootFolderItems = await GetFolderItems(rootId);
      
      console.log("root folder items:", rootFolderItems);
      
      // console.log("root folder items: ", await rootFolderItems.json());
      
      var targetedFolder;
      
      rootFolderItems.forEach(folder => {
         if (folder.name == "ListeProperties"){
            targetedFolder = folder
         }
      });
      
      console.log("targetedFolder: ", targetedFolder);
      
      console.log("model enitty: ", modelEntities[0]);

      var entityInfoString = modelInfoString.concat(`/${modelEntities[0].id}`);

      console.log("entity info string: ", entityInfoString);

      // console.log("entityinfosstring:",entityInfoString);
      // console.log("headers:",headers);
      // console.log("params:",params);

      // var entityInfo = await GetRequest(entityInfoString, headers, params);

      const responseEntityIbfo = await fetch(entityInfoString + '?' + new URLSearchParams(params), {
        method: 'GET',
        headers: {
           'Content-Type': 'application/json',
           'Authorization': `Bearer ${accessToken}`
         }
      });

      const entityInfoJson = await responseEntityIbfo.json();

      console.log("entity infos json: ", entityInfoJson);

      var psetsArray = new Array();
      
      psetsArray = entityInfoJson.psets;

      console.log("psetsArray: ", psetsArray);

      var pset;

      psetsArray.forEach(object => {
         if (object.name == 'Project_Identification') {
            pset = object;
         }
      });

      console.log("pset: ", pset);

      var stringToSplit = `${pset.values[0]}`;

      console.log("stringToSplit: ", stringToSplit);

      var splitedString = new Array();

      splitedString = stringToSplit.split('-');

      console.log("splitedString: ", splitedString);

      var targetedFolderId = targetedFolder.id;

      for (let iRow = 0; iRow < splitedString.length; iRow++) 
      {
         try 
         {
            const string = splitedString[iRow];
            
            var responseCreation = await createFolder(string, targetedFolderId, accessToken);
            console.log("response creation folder: ", responseCreation);
         } 
         catch (error) 
         {
            console.log("folders creation error: ", error);
            responseCreation = [];
         }
      }

         // splitedString.forEach(async (string) => {
         // //    if (responseCreation.errorcode == "DUPLICATE_NAME" && responseCreation)
         // //    {
               // var responseCreation = await createFolder(string, targetedFolderId, accessToken);
               // console.log("response creation folder: ", responseCreation)
         //       // if (responseCreation.success)
         //    // }
         // })

      // let responseCreation = await responseCreateFolder.json();

      // console.log("responseFolderCreation: ", responseCreation);
    }

    async function createFolder(name, parentId, acccessToken)
    {
      var responseCreateFolder = await fetch(appBaseString.concat("folders"), {
               method:"POST",
               body: JSON.stringify({
                  "name":`${name}`,
                  "parentId":`${parentId}`
               }),
               headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${accessToken}`
               }
            });

         var responseCreation = await responseCreateFolder.json();

         return responseCreation;
    }
 
    async function GetFolderItems(folderId)
    {
      const responseFolderInfo =  await fetch(appBaseString.concat(`folders/${folderId}/items`), {
         method: 'GET',
         headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }
      });

      const result = await responseFolderInfo.json();

      return result;
    }
 
 </script>
</body>
</html>
