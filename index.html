<!DOCTYPE html>
<html>
<head>
	<title>My JavaScript Project</title>
	
	<script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
	
	<script src="https://unpkg.com/xdomain@0.8.2/dist/xdomain.min.js"></script>
</head>
<body>
   <script type="module">
      import {ProjectClass} from "./Models/Project.js";
   </script>
<!-- <script src="https://jonathang89.github.io/TrimbleConnectTest/script.js"/> -->

<script type="module">
   // import * from "./Models/Project.js";
   xdomain.slaves({
    "https://pset-api.connect.trimble.com": "/v1/proxy.html",
    "https://org-api.connect.trimble.com": "/v1/proxy.html"
  });
    console.log("Test log");
    	
    getData();

    async function getData() {

      var selection;

     const API = await TrimbleConnectWorkspace.connect(window.parent, (event, data) => {
        console.log("Event: ", event, data);
      });
      
      console.log("Window Parent: ", window.parent);
      
      const responseProject = await API.project.getProject();
      console.log("Response Project: ", responseProject); // Trimble Connect project details
      const projectId = responseProject.id;
      
      const responseAccessToken = await API.extension.requestPermission("accesstoken");
      console.log("responseAccessToken: ", responseAccessToken);
      const accessToken = responseAccessToken;
      
      const psetBaseString = 'https://pset-api.connect.trimble.com/v1/';
      const orgBaseString = "https://org-api.connect.trimble.com/v1/";
      const appBaseString = "https://app21.connect.trimble.com/tc/api/2.0/";
      
      const projectForestString = orgBaseString.concat(`forests/project:${projectId}:data/trees/ProjectContext/nodes/PSetLibs`);
      // const projectForestNodeString = orgBaseString.concat(`forests`);

      const appBaseStringProject = appBaseString.concat(`projects/${projectId}`);
      
      console.log("debut test: ");
      
      const responseModel = await API.viewer.getModels();
      const model = responseModel[2];
      
      console.log("response model: ", responseModel);
      console.log("modelId: ", model);
      
      const responseAppBaseString =  await fetch(appBaseStringProject, {
         method: 'GET',
         headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }
      });
      
      const responseAppBaseStringJson = await responseAppBaseString.json();
      
      console.log("response app base string: ", responseAppBaseStringJson);
      
      const projectRootId = responseAppBaseStringJson.rootId;
      
      console.log("rootId: ", projectId);

      const appBaseStringFolderProject = appBaseString.concat(`folders/${projectRootId}/items`);

     const responseAppBaseFolderString =  await fetch(appBaseStringFolderProject, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        }
     });

     const responseAppBaseFolderStringJson = await responseAppBaseFolderString.json();

     console.log("Folder json: ", responseAppBaseFolderStringJson);

     let childFolder = responseAppBaseFolderStringJson[1];

     let childFolderString = appBaseString.concat(`folders/${childFolder.id}/items`);

     const responseChildFolderItems =  await fetch(childFolderString, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        }
     });

     const childFolderItems = await responseChildFolderItems.json();

     console.log("ChildFolder Items: ", childFolderItems);

      // const responseLoadedModel = await API.viewer.getLoadedModel(`${model.id}`);

      // console.log("responseLoadedModel: ", responseLoadedModel);

     const responseForest = await fetch(projectForestString, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        }
     });

   //   const responseForestSearch = await fetch(projectForestNodeString, {
   //      method: 'GET',
   //      headers: {
   //          'Content-Type': 'application/json',
   //          'Authorization': `Bearer ${accessToken}`
   //      }
   //   });

   //   const jsonResponseSearch = await responseForestSearch.json();
   //   console.log("search response: ", jsonResponseSearch);

     const responseForestJson = await responseForest.json();
     const libId = responseForestJson.links[0].substring(8);
     
     console.log("response Forest json: ", responseForestJson);
     console.log("libId: ", libId);

     const getLibString = `${psetBaseString}libs/${libId}`;
     const getLibDefsString = `${getLibString}/defs`;

     const responseLib = await fetch(getLibString, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        }
     });

     console.log("get library:", await responseLib.json());

     const responseLibDefs = await fetch(getLibDefsString, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        }
     });

     const LibDefs = await responseLibDefs.json();
     const firstLibDef = LibDefs.items[0];

     console.log("get library defs:", firstLibDef);
     
     const defId = firstLibDef.id;
     
     const getLibDefsPsetString = `${getLibDefsString}/${defId}/psets`;

      const responsePset = await fetch(getLibDefsPsetString, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        }
     });

     console.log("response pset: ", await responsePset.json());
     
    }
 </script>
	
</body>
</html>
