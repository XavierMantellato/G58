<!DOCTYPE html>
<html>
<head>
	<title>My JavaScript Project</title>
	
   <link rel="stylesheet" type="text/css" href="./CSS/index.css">
	<script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>

   <!-- Models -->
   <script src="./ModelsJs/Project.js"></script>
   <script src="./ModelsJs/Folder.js"></script>

   <!-- Helpers -->
   <script src="./ModelsJs/API_Rests/PsetsRequests.js"></script>
   <script src="./Helpers/RequestHelper.js"></script>
	
	<script src="https://unpkg.com/xdomain@0.8.2/dist/xdomain.min.js"></script>
</head>
<body>

   <h2 class="Title2-center">Arkance Extension</h2>

   <hr>
   
   <div style="text-align: center; margin: 5px;">
      <label>Folder creation</label>
      <button id="btnCreate">Create</button>
      <p id="CreationResponse"></p>
   </div>

<!-- <script src="https://jonathang89.github.io/TrimbleConnectTest/script.js"/> -->
<script type="module">
   xdomain.slaves({
    "https://pset-api.connect.trimble.com": "/v1/proxy.html",
    "https://org-api.connect.trimble.com": "/v1/proxy.html"
  });
   //  console.log("Test log");

      const psetBaseString = 'https://pset-api.connect.trimble.com/v1/';
      const orgBaseString = "https://org-api.connect.trimble.com/v1/";
      const appBaseString = "https://app21.connect.trimble.com/tc/api/2.0/";
      const modelApiBaseString = "https://model-api21.connect.trimble.com/";

      console.log("Api:");

      var accessToken;

      const API = await TrimbleConnectWorkspace.connect(window.parent, (event, args) => {
         switch (event) {
            case "extension.accessToken: ":

               console.log("AccessToken or status: ", args.data);
               break;
         
            default:
         }
        console.log("Event: ", event, args);
      });

      const responseProject = await API.project.getProject();
      console.log("Response Project: ", responseProject); // Trimble Connect project details
      const projectId = responseProject.id;

      const responseAccessToken = await API.extension.requestPermission("accesstoken");
      console.log("responseAccessToken: ", responseAccessToken);
      accessToken = responseAccessToken;
    	
      var headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }

      const projectForestString = orgBaseString.concat(`forests/project:${projectId}:data/trees/ProjectContext/nodes/PSetLibs`);

      const projectForestTreesString = orgBaseString.concat(`forests/project:${projectId}:data/trees`);

      const appProjectInfoProject = appBaseString.concat(`projects/${projectId}`);

      const responseProjectInfo =  await fetch(appProjectInfoProject, {
         method: 'GET',
         headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }
      });

      let projectInfo = await responseProjectInfo.json();
      var rootId = projectInfo.rootId;
      
      console.log("rootFolderId: ", rootId);

      const responseModels = await API.viewer.getModels();

      console.log("models: ", responseModels);

      const model = responseModels[2];

      console.log("endApi:")
   
   document.getElementById("btnCreate").onclick = function() { createFolderHierarchy() };

   async function createFolderHierarchy()
    {
      const responseModel = await API.viewer.getModels();
      const model = responseModel[2];

      var params = "include=id,idx,psets,psets.name";

      let modelInfos = await GetmodelEntities(model.id, accessToken);

      console.log("modelInfos",modelInfos);

      let modelEntities = modelInfos.items;

      console.log("modelEntities: ", modelEntities);

      const responseProjectInfo =  await fetch(appProjectInfoProject, {
         method: 'GET',
         headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }
      });

      console.log("creating folder:");

      let rootFolderItems = await GetFolderItems(rootId);
      
      console.log("root folder items:", rootFolderItems);
      
      var baseFolder;
      
      rootFolderItems.forEach(folder => {
         if (folder.name == "Test Arkance")
         {
            baseFolder = folder;
         }
      });
      
      var baseFolderModel = new Folder(baseFolder.id, "Test Arkance");
      
      var targetedFolder = baseFolderModel;

      console.log("baseFolderModel: ", baseFolderModel);

      console.log("targetedFolder: ", targetedFolder);
      
      // await modelEntities.forEach(async (entity) => {
         var entityId = modelEntities[564].id;
         // var entityId = entity.id;

         var responseEntityInfo = await GetEntityInfo(model.id, accessToken, entityId, params);

         let psetsArray = new Array()

         psetsArray = responseEntityInfo.psets;

         console.log("psetsArray: ", psetsArray);

         var psetIdentification;

         psetsArray.forEach(object => {
            if (object.name == 'Project_Identification') {
               psetIdentification = object;
            }
         });

         // console.log("pset: ", pset);

         var stringToSplit = `${psetIdentification.values[0]}`;

         // console.log("stringToSplit: ", stringToSplit);

         var splitedString = new Array();

         splitedString = stringToSplit.split('-');

         console.log("splitedString: ", splitedString);

         var createdFolders = new Array();

         var targetedFolderId = baseFolder.id;

            for (let iRow = 0; iRow < splitedString.length; iRow++) 
            {
               const string = splitedString[iRow].trim();
               try 
               {
                  if (createdFolders.includes(folder => folder.Name == string))
                  {
                     targetedFolderId = createdFolders.find(folder => folder.Name == string).Id;
                     console.log("skip: ", targetedFolderId);
                     continue;
                  }
                  
                  var responseCreation = await createFolder(string, targetedFolderId, accessToken);

                  console.log("response creation folder: ", responseCreation);

                  createdFolders
                     .push(
                        new Folder(
                           responseCreation.id,
                           string)
                           );

                  console.log("createdFolders: ", createdFolders);
                  
                     // targetedFolderId = responseCreation.id
               }
               catch (error) 
               {
                  console.log("error line 207: ", error);            
               }
            }

         // })
         document.getElementById("CreationResponse").innerText = "Folders created";

      // var entityInfoString = modelInfoString.concat(`/${modelEntities[0].id}`);

      // console.log("entity info string: ", entityInfoString);

      // console.log("entityinfosstring:",entityInfoString);
      // console.log("headers:",headers);
      // console.log("params:",params);

      // var entityInfo = await GetRequest(entityInfoString, headers, params);

      // const responseEntityIbfo = await fetch(entityInfoString + '?' + new URLSearchParams(params), {
      //   method: 'GET',
      //   headers: {
      //      'Content-Type': 'application/json',
      //      'Authorization': `Bearer ${accessToken}`
      //    }
      // });

      // const entityInfoJson = await responseEntityIbfo.json();

      // console.log("entity infos json: ", entityInfoJson);

      // var psetsArray = new Array();

         // splitedString.forEach(async (string) => {
         // //    if (responseCreation.errorcode == "DUPLICATE_NAME" && responseCreation)
         // //    {
               // var responseCreation = await createFolder(string, targetedFolderId, accessToken);
               // console.log("response creation folder: ", responseCreation)
         //       // if (responseCreation.success)
         //    // }
         // })

      // let responseCreation = await responseCreateFolder.json();

      // console.log("responseFolderCreation: ", responseCreation);
    }

    async function createFolder(name, parentId, acccessToken)
    {
      try 
      {
         var responseCreateFolder = await fetch(appBaseString.concat("folders"), {
               method:"POST",
               body: JSON.stringify({
                  "name":`${name}`,
                  "parentId":`${parentId}`
               }),
               headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${accessToken}`
               }
            });

         var responseCreation = await responseCreateFolder.json();

         return responseCreation;
      } 
      catch (error) 
      {
         return error;
      }
    }
 
    async function GetFolderItems(folderId)
    {
      const responseFolderInfo =  await fetch(appBaseString.concat(`folders/${folderId}/items`), {
         method: 'GET',
         headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }
      });

      const result = await responseFolderInfo.json();

      return result;
    }
 
    async function GetmodelEntities(modelId, accessToken)
    {
      const responseModelInfo =  await fetch(modelApiBaseString.concat(`models/${modelId}/entities`), {
         method: 'GET',
         headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }
      });

      let modelInfos = await responseModelInfo.json();

      return modelInfos;
    }

    async function GetEntityInfo(modelId, accessToken, entityId, params)
    {
      const responseModelInfo =  await fetch(modelApiBaseString.concat(`models/${modelId}/entities/${entityId}`) + '?' + new URLSearchParams(params), {
         method: 'GET',
         headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }
      });

      let modelInfos = await responseModelInfo.json();

      return modelInfos;
    }

    async function GetFolder(folderId)
    {
      const responseFolderInfo =  await fetch(appBaseString.concat(`folders/${folderId}`), {
         method: 'GET',
         headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }
      });

      const result = await responseFolderInfo.json();

      return result;
    }

 </script>
</body>
</html>
