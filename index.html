<!DOCTYPE html>
<html>
<head>
	<title>My JavaScript Project</title>
	
	<script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
   <script src="./Models/Project.js"></script>
   <script src="./API_Rests/PsetsRequests.js"></script>
	
	<script src="https://unpkg.com/xdomain@0.8.2/dist/xdomain.min.js"></script>
</head>
<body>
   <p>
      <h3>Selected Model</h3>
      <div id="test"></div>
      <h4>Selected entity id</h4>
      <div id="entityId"></div>
   </p>
<!-- <script src="https://jonathang89.github.io/TrimbleConnectTest/script.js"/> -->

<script type="text/javascript">

   xdomain.slaves({
    "https://pset-api.connect.trimble.com": "/v1/proxy.html",
    "https://org-api.connect.trimble.com": "/v1/proxy.html"
  });
    console.log("Test log");
    	
    getData();

    async function getData() {

      var selection;

     const API = await TrimbleConnectWorkspace.connect(window.parent, (event, data) => {
        console.log("Event: ", event, data);
      });
      
      console.log("Window Parent: ", window.parent);
      
      const responseProject = await API.project.getProject();
      console.log("Response Project: ", responseProject); // Trimble Connect project details
      const projectId = responseProject.id;

      // const projectInstance = new ProjectClass(responseProject.id, responseProject.name);

      // console.log("Project instance:", projectInstance);
      
      const responseAccessToken = await API.extension.requestPermission("accesstoken");
      console.log("responseAccessToken: ", responseAccessToken);
      const accessToken = responseAccessToken;
      
      const psetBaseString = 'https://pset-api.connect.trimble.com/v1/';
      const orgBaseString = "https://org-api.connect.trimble.com/v1/";
      const appBaseString = "https://app21.connect.trimble.com/tc/api/2.0/";
      const modelApiBaseString = "https://model-api21.connect.trimble.com/"
      
      const projectForestString = orgBaseString.concat(`forests/project:${projectId}:data/trees/ProjectContext/nodes/PSetLibs`);
      // const projectForestNodeString = orgBaseString.concat(`forests`);

      const appProjectInfoProject = appBaseString.concat(`projects/${projectId}`);
      
      console.log("debut test: ");
      
      const responseProjectInfo =  await fetch(appProjectInfoProject, {
         method: 'GET',
         headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }
      });
      
      let projectInfo = await responseProjectInfo.json();
      let rootId = projectInfo.rootId;
      
      console.log("baseFolderId: ", rootId);

      const appBaseFolderString = appBaseString.concat(`folders/${rootId}/items`);

      const responseFolderInfo =  await fetch(appBaseFolderString, {
         method: 'GET',
         headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }
      });

      let rootFolderItems = await responseFolderInfo.json()

      console.log("root folder items: ", rootFolderItems);

      var targetedFolder;
      
      rootFolderItems.forEach(folder => {
         if (folder.name == "ListeProperties"){
            targetedFolder = folder
         }
      });

      console.log("targetedFolder: ", targetedFolder);

      const responseModel = await API.viewer.getModels();
      const model = responseModel[2];
      
      console.log("response model: ", responseModel);
      console.log("modelId: ", model.id);

      document.getElementById('test').innerHTML = model.name;

      const modelInfoString = modelApiBaseString.concat(`models/${model.id}/entities`);
      
      const responseModelInfo =  await fetch(modelInfoString, {
         method: 'GET',
         headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }
      });

      let modelInfos = await responseModelInfo.json();

      let modelEntities = modelInfos.items;
      
      let entityFrnTest = `frn:entity:${modelEntities[0].id}`;

      let psetForEntityTestString = psetBaseString.concat(`psets/${entityFrnTest}`);

      let responseEntityPsetTest = await fetch(psetForEntityTestString, {
         method: 'GET',
         headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }
      });

      console.log("test PsetsRequests: ", await responseEntityPsetTest.json());

      console.log("model entites: ", modelEntities)

      let entities = new Array();

      console.log("num: ", modelEntities.length);

      for (let index = 0; index < modelEntities.length; index++) {
         let entityId = modelEntities[index].id
         let entityFrn = `frn:entity:${entityId}`;

         let psetForEntityString = psetBaseString.concat(`psets/${entityFrn}`);

         let responseEntityPset = await fetch(psetForEntityString, {
         method: 'GET',
         headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
         }
      });

         entities.push(await responseEntityPset.json());
         console.log("entity added: ", responseEntityPset);
   };

      console.log("entities", entities);

      // document.getElementById('entityId').innerHTML = entityId;

      // console.log(entityId);


      // console.log("entity frn: ", entityFrn)

     const responseForest = await fetch(projectForestString, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        }
     });

   //   let encodedEntityFrn = encodeURIComponent(entityFrn);

   //   console.log("encoded entity frn: ", encodedEntityFrn);

     

     const responseForestJson = await responseForest.json();
     const libId = responseForestJson.links[0].substring(8);
     
     console.log("response Forest json: ", responseForestJson);
     console.log("libId: ", libId);

     const getLibString = `${psetBaseString}libs/${libId}`;
     const getLibDefsString = `${getLibString}/defs`;

     const responseLib = await fetch(getLibString, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        }
     });

     console.log("get library:", await responseLib.json());

   //   let responseApiRestTest = await PsetGetRequest(`libs/${libId}`, accessToken).json();

   //   console.log("Api Rest Test: ", responseApiRestTest);

     const responseLibDefs = await fetch(getLibDefsString, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        }
     });

     const LibDefs = await responseLibDefs.json();

     console.log("library definitions: ", LibDefs);

     const firstLibDef = LibDefs.items[0];

     console.log("get first library def:", firstLibDef);

     const defId = firstLibDef.id;

   //   const getEntityPsetByDefIdString = psetForEntityString.concat(`/${libId}/${defId}`);

   //   const responseEntityPsetByDefId = await fetch(getEntityPsetByDefIdString, {
   //      method: 'GET',
   //      headers: {
   //          'Content-Type': 'application/json',
   //          'Authorization': `Bearer ${accessToken}`
   //      }
   //   });

   //   let entityPsetByDefId = await responseEntityPsetByDefId.json();

   //   console.log("entityPsetByDefId", entityPsetByDefId);

      var header = {
               'Content-Type': 'application/json charset=UTF-8',
               'Authorization': `Bearer ${accessToken}`
             };

      console.log("header", header);

      var testBody = {
               "props": 
                  {
                     "prop_fn1lmx6z7qwngdy1g7qubrlvmub416h3": 'Valeur Test Patched'
                  }
         };
      
         console.log("test body: ", testBody);

   //   const responseEntityPsetByDefIdPatch = await fetch(getEntityPsetByDefIdString, {
   //      method: 'PATCH',
   //      body: JSON.stringify({
   //             "props": 
   //                {
   //                   "prop_fn1lmx6z7qwngdy1g7qubrlvmub416h3": "Salut c'est moi"
   //                }
   //       }),
   //      headers: {
   //          'Content-Type': 'application/json',
   //          'Authorization': `Bearer ${accessToken}`
   //      },
   //   });

   //   let entityPsetPatch = await responseEntityPsetByDefIdPatch.json();

   //   console.log("patched entity pSet: ", entityPsetPatch);
     
     const getLibDefsPsetString = `${getLibDefsString}/${defId}/psets`;

      const responsePset = await fetch(getLibDefsPsetString, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        }
     });

     var projectInstance = new ProjectClass(responseProject.id, responseProject.name);

     console.log("projectInstance: ",projectInstance);

     console.log("response pset: ", await responsePset.json());
     
    }
 </script>
	
</body>
</html>
